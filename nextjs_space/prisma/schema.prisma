generator client {
    provider = "prisma-client-js"
    binaryTargets = ["native", "linux-musl-arm64-openssl-3.0.x"]
    output   = "../node_modules/@prisma/client"
}


datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

enum AIModelType {
  LARGE_LANGUAGE_MODEL
  COMPUTER_VISION
  PREDICTIVE_ANALYTICS
  NATURAL_LANGUAGE_PROCESSING
  RECOMMENDER_SYSTEM
  ROBOTICS_AUTONOMOUS
  OTHER
}

enum DeploymentStatus {
  DEVELOPMENT
  TESTING
  PRODUCTION
  RETIRED
}

enum RiskClassification {
  NOT_YET_ASSESSED
  MINIMAL_RISK
  LIMITED_RISK
  HIGH_RISK
  PROHIBITED
}

enum ProcessingVolume {
  LESS_THAN_1000
  FROM_1000_TO_10000
  FROM_10000_TO_100000
  OVER_100000
}

enum HighRiskCategory {
  BIOMETRIC_IDENTIFICATION
  CRITICAL_INFRASTRUCTURE
  EDUCATION_EMPLOYMENT
  ESSENTIAL_SERVICES
  LAW_ENFORCEMENT
  MIGRATION_ASYLUM
  JUSTICE_DEMOCRACY
  OTHER
}

enum ImplementationLevel {
  NOT_ADDRESSED
  PARTIALLY_ADDRESSED
  FULLY_ADDRESSED
}

enum NISTMaturityLevel {
  INITIAL
  DEVELOPING
  DEFINED
  MANAGED
  OPTIMISING
}

enum ComplianceConfidenceLevel {
  LOW
  MEDIUM
  HIGH
}

model AISystem {
  system_id           String              @id @default(cuid())
  system_name         String              @unique @db.VarChar(200)
  system_purpose      String              @db.VarChar(1000)
  business_owner      String
  technical_owner     String
  ai_model_type       AIModelType
  deployment_status   DeploymentStatus
  deployment_date     DateTime?
  data_sources        String[]
  vendor_provider     String?
  integration_points  String?
  processing_volume   ProcessingVolume
  risk_classification RiskClassification  @default(NOT_YET_ASSESSED)
  date_added          DateTime            @default(now())
  last_modified       DateTime            @updatedAt
  modified_by         String
  
  euAIActAssessments       EUAIActAssessment[]
  ukAIRegulationAssessments UKAIRegulationAssessment[]
  nistAIRMFAssessments     NISTAIRMFAssessment[]
  crossFrameworkAnalyses   CrossFrameworkAnalysis[]
  biasTests                BiasTest[]
  modelCards               ModelCard[]

  @@map("ai_systems")
}

model EUAIActAssessment {
  assessment_id                String               @id @default(cuid())
  system_id                    String
  risk_tier                    RiskClassification
  prohibited_trigger           String?              @db.Text
  high_risk_categories         HighRiskCategory[]
  compliance_requirements      String[]
  conformity_assessment_needed Boolean              @default(false)
  ce_marking_required          Boolean              @default(false)
  human_oversight_required     Boolean              @default(false)
  transparency_obligations     String[]
  assessment_date              DateTime             @default(now())
  assessed_by                  String
  notes                        String?              @db.Text
  
  // Questionnaire responses (stored for audit trail)
  prohibited_responses         Json?
  high_risk_responses          Json?
  limited_risk_responses       Json?
  
  aiSystem                     AISystem             @relation(fields: [system_id], references: [system_id], onDelete: Cascade)
  
  @@map("eu_ai_act_assessments")
  @@index([system_id])
}

model UKAIRegulationAssessment {
  assessment_id                   String               @id @default(cuid())
  system_id                       String
  safety_security_robustness      ImplementationLevel  @default(NOT_ADDRESSED)
  transparency_explainability     ImplementationLevel  @default(NOT_ADDRESSED)
  fairness                        ImplementationLevel  @default(NOT_ADDRESSED)
  accountability_governance       ImplementationLevel  @default(NOT_ADDRESSED)
  contestability_redress          ImplementationLevel  @default(NOT_ADDRESSED)
  sector_specific_requirements    String[]
  overall_compliance_score        Float                @default(0)
  gaps_identified                 String[]
  assessment_date                 DateTime             @default(now())
  assessed_by                     String
  notes                           String?              @db.Text
  
  // Questionnaire responses (stored for audit trail)
  questionnaire_responses         Json?
  
  aiSystem                        AISystem             @relation(fields: [system_id], references: [system_id], onDelete: Cascade)
  
  @@map("uk_ai_regulation_assessments")
  @@index([system_id])
}

model NISTAIRMFAssessment {
  assessment_id                   String               @id @default(cuid())
  system_id                       String
  govern_score                    Float                @default(0)
  map_score                       Float                @default(0)
  measure_score                   Float                @default(0)
  manage_score                    Float                @default(0)
  trustworthy_characteristics     Json?
  overall_maturity_level          NISTMaturityLevel    @default(INITIAL)
  recommendations                 String[]
  assessment_date                 DateTime             @default(now())
  assessed_by                     String
  notes                           String?              @db.Text
  
  // Questionnaire responses (stored for audit trail)
  questionnaire_responses         Json?
  
  aiSystem                        AISystem             @relation(fields: [system_id], references: [system_id], onDelete: Cascade)
  
  @@map("nist_ai_rmf_assessments")
  @@index([system_id])
}

model CrossFrameworkAnalysis {
  analysis_id                     String                     @id @default(cuid())
  system_id                       String
  frameworks_assessed             String[]
  coverage_gaps                   String[]
  overlapping_requirements        String[]
  priority_actions                String[]
  compliance_confidence_level     ComplianceConfidenceLevel  @default(MEDIUM)
  next_review_date                DateTime?
  analysis_date                   DateTime                   @default(now())
  assessed_by                     String
  notes                           String?                    @db.Text
  
  aiSystem                        AISystem                   @relation(fields: [system_id], references: [system_id], onDelete: Cascade)
  
  @@map("cross_framework_analyses")
  @@index([system_id])
}

enum BiasTestType {
  DEMOGRAPHIC_PARITY
  EQUAL_OPPORTUNITY
  EQUALISED_ODDS
  PREDICTIVE_PARITY
  CALIBRATION
  INDIVIDUAL_FAIRNESS
}

enum BiasTestStatus {
  PLANNED
  IN_PROGRESS
  COMPLETED
  REMEDIATION_NEEDED
  REMEDIATION_COMPLETE
}

enum BiasSeverityLevel {
  CRITICAL
  HIGH
  MEDIUM
  LOW
  NO_ISSUES
}

enum RemediationPriority {
  CRITICAL
  HIGH
  MEDIUM
  LOW
}

enum RemediationStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
  BLOCKED
}

enum StatisticalSignificance {
  SIGNIFICANT
  NOT_SIGNIFICANT
  INCONCLUSIVE
}

model BiasTest {
  test_id                     String              @id @default(cuid())
  system_id                   String
  test_name                   String
  test_type                   BiasTestType
  protected_attributes_tested String[]
  dataset_description         String              @db.Text
  sample_size                 Int
  test_date                   DateTime            @default(now())
  tested_by                   String
  test_methodology            String              @db.Text
  results                     Json?
  overall_fairness_score      Float               @default(0)
  issues_detected             Boolean             @default(false)
  severity_level              BiasSeverityLevel   @default(NO_ISSUES)
  status                      BiasTestStatus      @default(PLANNED)
  notes                       String?             @db.Text
  
  aiSystem                    AISystem            @relation(fields: [system_id], references: [system_id], onDelete: Cascade)
  testResults                 BiasTestResult[]
  remediationActions          RemediationAction[]
  
  @@map("bias_tests")
  @@index([system_id])
  @@index([status])
}

model BiasTestResult {
  result_id                String                    @id @default(cuid())
  test_id                  String
  protected_attribute      String
  reference_group          String
  comparison_group         String
  metric_name              String
  reference_group_value    Float
  comparison_group_value   Float
  disparity_ratio          Float
  passes_threshold         Boolean
  statistical_significance StatisticalSignificance  @default(INCONCLUSIVE)
  
  biasTest                 BiasTest                 @relation(fields: [test_id], references: [test_id], onDelete: Cascade)
  
  @@map("bias_test_results")
  @@index([test_id])
}

model RemediationAction {
  action_id           String              @id @default(cuid())
  test_id             String
  issue_description   String              @db.Text
  recommended_action  String              @db.Text
  assigned_to         String
  priority            RemediationPriority
  status              RemediationStatus   @default(NOT_STARTED)
  due_date            DateTime?
  completion_date     DateTime?
  notes               String?             @db.Text
  follow_up_test_required Boolean         @default(false)
  created_at          DateTime            @default(now())
  
  biasTest            BiasTest            @relation(fields: [test_id], references: [test_id], onDelete: Cascade)
  
  @@map("remediation_actions")
  @@index([test_id])
  @@index([status])
  @@index([priority])
}

enum ModelCardStatus {
  DRAFT
  UNDER_REVIEW
  APPROVED
  PUBLISHED
  ARCHIVED
}

enum UpdateFrequency {
  CONTINUOUS
  MONTHLY
  QUARTERLY
  ANNUALLY
  AS_NEEDED
}

model ModelCard {
  card_id                      String            @id @default(cuid())
  system_id                    String
  card_version                 String            @default("1.0")
  status                       ModelCardStatus   @default(DRAFT)
  
  // Section 1: Model Details
  model_details_summary        String?           @db.Text
  model_architecture           String?
  licence                      String?
  citation                     String?           @db.Text
  
  // Section 2: Intended Use & Limitations
  intended_use                 String?           @db.Text
  intended_users               String[]
  intended_deployment_contexts String?           @db.Text
  out_of_scope_uses            String[]
  limitations_known            String[]
  trade_offs                   String?           @db.Text
  
  // Section 3: Training Data
  training_data_description    String?           @db.Text
  training_data_size           Int?
  training_data_source         String?
  data_collection_methodology  String?           @db.Text
  preprocessing_steps          String[]
  data_labelling_approach      String?           @db.Text
  sensitive_data_handling      String?           @db.Text
  
  // Section 4: Performance Metrics
  evaluation_metrics           Json?
  performance_results          Json?
  benchmark_comparisons        String?           @db.Text
  
  // Section 5: Ethical Considerations & Fairness
  fairness_assessment_summary  String?           @db.Text
  potential_risks_harms        String?           @db.Text
  human_oversight_requirements String?           @db.Text
  contestability_mechanisms    String?           @db.Text
  ethical_considerations       String?           @db.Text
  
  // Section 6: Deployment & Monitoring
  deployment_recommendations   String?           @db.Text
  monitoring_requirements      String?           @db.Text
  monitoring_plan              String?           @db.Text
  update_frequency             UpdateFrequency   @default(AS_NEEDED)
  update_triggers              String?           @db.Text
  decommissioning_criteria     String?           @db.Text
  
  // Section 7: Regulatory Compliance Context
  regulatory_compliance_summary String?          @db.Text
  
  // Section 8: Review & Approval
  last_updated                 DateTime          @default(now())
  updated_by                   String
  approved_by                  String?
  approval_date                DateTime?
  reviewer_assigned            String?
  review_comments              String?           @db.Text
  publication_url              String?
  
  aiSystem                     AISystem          @relation(fields: [system_id], references: [system_id], onDelete: Cascade)
  
  @@map("model_cards")
  @@index([system_id])
  @@index([status])
  @@index([card_version])
}


// ============================================================================
// MODULE 6: THIRD-PARTY AI VENDOR RISK ASSESSMENT
// ============================================================================

enum VendorRiskTier {
  CRITICAL
  HIGH
  MEDIUM
  LOW
  NOT_ASSESSED
}

enum VendorAssessmentStatus {
  NOT_STARTED
  IN_PROGRESS
  UNDER_REVIEW
  APPROVED
  REJECTED
  REASSESSMENT_REQUIRED
}

enum VendorComplianceStatus {
  COMPLIANT
  NON_COMPLIANT
  PARTIALLY_COMPLIANT
  PENDING_VERIFICATION
  NOT_APPLICABLE
}

enum DocumentType {
  CONTRACT
  SLA
  DPA
  PRIVACY_POLICY
  SECURITY_CERTIFICATE
  AUDIT_REPORT
  MODEL_CARD
  COMPLIANCE_ATTESTATION
  INSURANCE_CERTIFICATE
  OTHER
}

enum DocumentStatus {
  CURRENT
  EXPIRING_SOON
  EXPIRED
  UNDER_REVIEW
  PENDING
}

enum ContractStatus {
  ACTIVE
  EXPIRING_SOON
  EXPIRED
  TERMINATED
  PENDING_RENEWAL
}

enum VendorStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  UNDER_REVIEW
  TERMINATED
}

model Vendor {
  vendor_id                   String                @id @default(cuid())
  vendor_name                 String                @unique @db.VarChar(200)
  legal_entity_name           String?               @db.VarChar(300)
  website                     String?
  headquarters_location       String?
  primary_contact_name        String
  primary_contact_email       String
  primary_contact_phone       String?
  vendor_status               VendorStatus          @default(ACTIVE)

  // Business Information
  services_provided           String[]
  industries_served           String[]
  company_size                String?
  years_in_business           Int?

  // Risk & Compliance
  overall_risk_tier           VendorRiskTier        @default(NOT_ASSESSED)
  last_assessment_date        DateTime?
  next_assessment_due         DateTime?

  // Metadata
  date_added                  DateTime              @default(now())
  last_modified               DateTime              @updatedAt
  added_by                    String

  // Relations
  assessments                 VendorAssessment[]
  contracts                   VendorContract[]
  documents                   VendorDocument[]
  complianceChecks            VendorComplianceCheck[]

  @@map("vendors")
  @@index([vendor_status])
  @@index([overall_risk_tier])
}

model VendorAssessment {
  assessment_id               String                  @id @default(cuid())
  vendor_id                   String
  assessment_date             DateTime                @default(now())
  assessed_by                 String
  status                      VendorAssessmentStatus  @default(IN_PROGRESS)

  // Assessment Sections (0-100 scores)
  security_score              Float                   @default(0)
  privacy_score               Float                   @default(0)
  ai_ethics_score             Float                   @default(0)
  reliability_score           Float                   @default(0)
  compliance_score            Float                   @default(0)
  transparency_score          Float                   @default(0)

  // Overall Assessment
  overall_score               Float                   @default(0)
  risk_tier                   VendorRiskTier          @default(NOT_ASSESSED)

  // Detailed Findings
  strengths                   String[]
  weaknesses                  String[]
  red_flags                   String[]
  recommendations             String[]

  // Decision
  approval_decision           String?
  approval_conditions         String[]
  decision_rationale          String?                 @db.Text
  approved_by                 String?
  approval_date               DateTime?

  // Follow-up
  next_review_date            DateTime?
  review_frequency_months     Int                     @default(12)

  notes                       String?                 @db.Text

  // Questionnaire responses
  questionnaire_responses     Json?

  vendor                      Vendor                  @relation(fields: [vendor_id], references: [vendor_id], onDelete: Cascade)

  @@map("vendor_assessments")
  @@index([vendor_id])
  @@index([status])
  @@index([assessment_date])
}

model VendorContract {
  contract_id                 String            @id @default(cuid())
  vendor_id                   String
  contract_title              String            @db.VarChar(300)
  contract_number             String?           @unique
  contract_status             ContractStatus    @default(ACTIVE)

  // Contract Dates
  start_date                  DateTime
  end_date                    DateTime
  renewal_date                DateTime?
  notice_period_days          Int?

  // Contract Terms
  contract_value_annual       Float?
  currency                    String            @default("GBP")
  payment_terms               String?

  // Key Clauses
  data_protection_terms       Boolean           @default(false)
  liability_cap_amount        Float?
  termination_clauses         String?           @db.Text
  sla_guarantees              String[]

  // Compliance Requirements
  gdpr_compliant              Boolean           @default(false)
  iso27001_required           Boolean           @default(false)
  soc2_required               Boolean           @default(false)
  other_certifications        String[]

  // Monitoring
  performance_kpis            Json?
  breach_notification_hours   Int?

  contract_owner              String
  notes                       String?           @db.Text

  created_at                  DateTime          @default(now())
  last_modified               DateTime          @updatedAt

  vendor                      Vendor            @relation(fields: [vendor_id], references: [vendor_id], onDelete: Cascade)

  @@map("vendor_contracts")
  @@index([vendor_id])
  @@index([contract_status])
  @@index([end_date])
}

model VendorDocument {
  document_id                 String            @id @default(cuid())
  vendor_id                   String
  document_type               DocumentType
  document_title              String            @db.VarChar(300)
  document_status             DocumentStatus    @default(CURRENT)

  // Document Details
  file_url                    String?
  file_name                   String?
  file_size_kb                Int?

  // Dates
  upload_date                 DateTime          @default(now())
  issue_date                  DateTime?
  expiry_date                 DateTime?
  last_reviewed_date          DateTime?
  next_review_date            DateTime?

  // Metadata
  uploaded_by                 String
  document_version            String            @default("1.0")
  is_confidential             Boolean           @default(false)
  requires_approval           Boolean           @default(false)
  approved_by                 String?
  approval_date               DateTime?

  notes                       String?           @db.Text

  vendor                      Vendor            @relation(fields: [vendor_id], references: [vendor_id], onDelete: Cascade)

  @@map("vendor_documents")
  @@index([vendor_id])
  @@index([document_type])
  @@index([document_status])
  @@index([expiry_date])
}

model VendorComplianceCheck {
  check_id                    String                  @id @default(cuid())
  vendor_id                   String
  framework_name              String
  check_date                  DateTime                @default(now())
  checked_by                  String

  compliance_status           VendorComplianceStatus  @default(PENDING_VERIFICATION)

  // Detailed Results
  requirements_checked        Json?
  compliant_items_count       Int                     @default(0)
  non_compliant_items_count   Int                     @default(0)
  not_applicable_items_count  Int                     @default(0)
  overall_compliance_percentage Float                 @default(0)

  // Findings
  critical_findings           String[]
  major_findings              String[]
  minor_findings              String[]
  observations                String[]

  // Actions
  corrective_actions_required String[]
  action_plan                 String?                 @db.Text
  remediation_deadline        DateTime?
  remediation_completed       Boolean                 @default(false)

  next_check_date             DateTime?
  notes                       String?                 @db.Text

  vendor                      Vendor                  @relation(fields: [vendor_id], references: [vendor_id], onDelete: Cascade)

  @@map("vendor_compliance_checks")
  @@index([vendor_id])
  @@index([framework_name])
  @@index([compliance_status])
}
